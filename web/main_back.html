<!doctype html>
<html>
  
  <head>
    <title>Button Grid Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

    <script src="js/qrcode.min.js"   type="text/javascript"></script>

    <link rel="stylesheet" href="css/bootstrap.css">
  

    <style type="text/css">

      body {

          padding-top: 50px;
          padding-bottom: 40px;
          background-color: #fcfcfc;
          font-size: 12px;
      }

      .container {
        
          /*  max-width: 1900px !important;  */
          /*  background-color: #eeeecc; */
      }


    .panel {
              
        border-radius: 1px 1px 1px 1px;
         box-shadow: 0 2px 2px rgba(0, 0, 0, 0.05); 
        /* margin-bottom: 20px; */
    }

    .panel-footer {

          background-color: #fcfcfc;
          padding: 5px 10px;
    }

    .btn-hit {

          padding: 3px;
          text-align: center;
          width: 28px;
          height: 28px;
          margin-right: 5px;
          margin-bottom: 5px;
        /*  font-weight: 600; */
    }


    .btn-group .btn {
          width: 100px;
     }


     .logbar { color: yellow; background: rgba(0, 0, 0, 0.8); border: none; }

       body .modal-dialog {
          /* new custom width */
          width: 700px;
          /* must be half of the width, minus scrollbar on the left (30px) */
         
        }


    </style>


  </head>
  
  <body>

   <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">PlayZa</a>
        </div>
        <div class="navbar-collapse collapse">
          
          <!-- <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>
              </ul>
            </li>
          </ul>  -->
         

          <!-- 
          <ul class="nav navbar-nav navbar-right">             
            <li><a href="#">Something else here   Test message !!!!  </a> </span></li>
            <li></li>
            <li></li>
          </ul>
          -->

           <div class="nav navbar-nav navbar-right" style="margin-top: 6px;" id="betpricebuttons">

                      <span><strong> Bet price per button  <i class='priceamount'> 0.0001 BTC </i> </strong> </span>
                      <span> &nbsp; &nbsp;</span>
                      <div class="btn-group">
                              <button type="button" class="btn btn-primary active" price="0.0001">0.0001</button>
                              <button type="button" class="btn btn-primary" price="0.001">0.001</button>
                              <button type="button" class="btn btn-primary" price="0.01">0.01</button>
                              <button type="button" class="btn btn-primary" price="0.1">0.1</button>
                      </div>
          </div>          

        </div> <!-- Eof navbar collapse  -->
      </div>
   </div>
    

    <div class="container">
      

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Your BTC account address</h4>
      </div>
      
      <div class="modal-body">

              <div class="row">

                <div class="col-md-5" id="qrcode"></div>  

                <div class="col-md-7">
                      <fieldset disabled>
                        <input type="text" class="form-control input-lg" id="btcadress">
                      </fieldset>
                      <br>
                      <a class="btn btn-success bitcoin-link" href="#" id="directpaymentbutton">Direct link for payment</a>
                      <br>
                      <div>
                        <h4>Price of every button is 0.001 BTC. You can multiply your bet by buttons in header.
                        Your account will be credited instantly in couple seconds. You can use this address forever.
                        </h4>
                      </div>
                </div>
             
              </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>      
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
    
       

      <!-- header View -->
      <div class="row" style="padding-top: 20px; padding-bottom: 20px;">  
       <div class="col-md-12" id="headerrow"> </div>            
      </div>    

      <!-- Button grid -->
      <div class="row">                    
          <!-- 
            <div class="col-md-3" id="bethistory"> 

                <table class="table">
                  <thead>
                      <tr>
                          <th>Bet</th>
                          <th>Win</th>
                          <th>Balance</th>                      
                      </tr>
                  </thead>
                </table>
             </div> 
         -->
          <div class="col-md-12" id="buttontable"> </div>        
      </div>



  <nav class="navbar navbar-default navbar-fixed-bottom logbar" role="navigation">
    <div class="container">
      
      <div class="pull-right" style="text-align: right; margin-right: 30px;">

        <span id="userbalance"></span> BTC<br>
        <span><strong id="buttonsremained"></strong> buttons to new map</span>

      </div>
      
      <div id="logs" class="pull-left">
          <!--
              <div><strong> 22:18:59</strong> revealed <strong>1.1</strong> button</div>
              <div><strong> 22:18:58</strong> revealed <strong>1.5</strong> button</div>
          -->
        </div>
    </div>
  </nav>


      
      <script type="text/template" id="header-template">

            <div class="col-md-6"> 
                <span id="gameidhash"> GameID:  </span> 
            </div>  

              <!-- 
              <div class="col-md-3"> 
                <div class="pull-right"> User Balance: <strong id="userbalance">  <%= data.BTCbalance %>  BTC </strong>  </div
              </div> 
              -->        
           
            <div class="col-md-6"> 
                <div>  <%= data.UserName %>  ~ <a href="#" data-toggle="modal" data-target="#myModal"> deposit  </a> ~ <a href="#"> withdrawal </a> 
                </div>
            </div>
      
      </script>


       <script type="text/template" id="button-template">

            <%  var a = 0; %>            
            <% _.each(data, function(item) {  %> 

                  <% console.log( _.uniq(item.desk)) %>
                  <% console.log( item.desk.length ) %>
                  
                 <%  _.each(item.desk, function(betsdata) { %>  

                        <% if(betsdata === 0) { %>                           
                                  <button class="btn btn-xs btn-hit" data-=index"<%= a %>">&nbsp;</button>                         
                        <% } else if(betsdata === 2)  {  %> 
                                   <button class="btn btn-xs btn-hit btn-warning" data-index="<%= a %>"><%= betsdata %></button> 
                        <% } else if(betsdata === 5)  {  %> 
                                   <button class="btn btn-xs btn-hit btn-success" data-index="<%= a %>"><%= betsdata %></button> 
                        <% } else if(betsdata === 5)  {  %>                         
                                   <button class="btn btn-xs btn-hit btn-warning" data-index="<%= a %>"><%= betsdata %></button>    
                        <% } else if(betsdata === 10)  {  %>                         
                                   <button class="btn btn-xs btn-hit btn-danger" data-index="<%= a %>"><%= betsdata %></button>
                        <% } else { %>
                                   <button class="btn btn-xs btn-hit btn-primary" data-index="<%= a %>"><%= betsdata %></button> 
                        <% }  %>

                   <% a ++; %>

                 <% }); %>

            <% }); %>


      </script>

  </body>

    
  <script src="js/jquery.min.js"></script> 
  <script src="js/Backbone/underscore.js" type="text/javascript"></script>
  <script src="js/Backbone/backbone.js"   type="text/javascript"></script>
  <script src="js/bootstrap.min.js"   type="text/javascript"></script>
  <script src="js/modal.js"   type="text/javascript"></script>


  <!--        
    <script  src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.0/zepto.min.js" type="text/javascript"></script> 
    <script  src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.0/underscore-min.js"  type="text/javascript"></script> 
    <script  src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"      type="text/javascript"></script>
  -->

  <script src="js/socketio/socket.io.js"></script>


    <script type="text/javascript">


        $(window).scroll(function() {
        
              if($(window).scrollTop() == $(document).height() - $(window).height()) {                         
                     console.log('Load More');
              }
        });

        var betPrice = 0.0001;



        $(document).ready(function() {


              // Price Buttons 
              $( "#betpricebuttons button" ).bind( "click", function(e) {

                  $("#betpricebuttons button" ).removeClass('active');                  
                  $(e.currentTarget).addClass('active');
                  var buttonbetprice = $(e.currentTarget).attr('price');
                  betPrice = parseFloat(buttonbetprice);
                  $('.priceamount').text(buttonbetprice);                                
              });



        
             var  GameButtons  = Backbone.Model.extend({

                  initialize: function()
                  {
                      //console.log('Model has been intilised !!!');
                  }

              });

              var GameButtonsCollection = Backbone.Collection.extend({
                  
                   url     : '/api/bets/'
                  ,model  :  GameButtons

                  ,initialize: function(){                      
                      //console.log('Collection has been itialised !!!');
                  }

              });


            // Header View 
            var HeaderView = Backbone.View.extend({
                el:  "#headerrow",
              
                render: function(data)
                {
                    //console.log('header grid rendered !!!', data);
                    this.$el.html(_.template($('#header-template').html(), { data: data } ));
                }

            });

             //-- Button View 
            var ButtonView = Backbone.View.extend({

                  el: '#buttontable',                  
                  render: function()
                  {
                     var that = this;
                     var remoteData = new GameButtonsCollection();                      
                      
                      remoteData.fetch({

                          success: function(remoteData)
                          {

                              // console.log('Te Game ID iiiis !!! ', (remoteData.toJSON()[0].gameID) );
                              // $('#gameidhash').text('aaaaa');                             
                              var template = _.template($('#button-template').html(), { data: remoteData.toJSON() });
                              that.$el.html(template);
                          }

                      });

                  }, events: {
                              
                        'click button': 'makebet'

                  }, makebet : function(e) {

                        var betId = $(e.currentTarget).attr('data-index');                       
                        socket.emit('makebet', { id: betId, amt:  betPrice });                        
                  }

              });



              var Router = Backbone.Router.extend({
                    routes: {

                        '': 'home'                                     
                    }
                });


              var router        = new Router();
              var _buttonsView  = new ButtonView();
              var _headerView   = new HeaderView();
              
              router.on('route:home', function () {               

              });
              
              
            Backbone.history.start();


            //-- Scoket Part !
            var socket = io.connect('http://localhost:5000/');
            
            socket.on('firstload', function (data) {
                _buttonsView.render();              
            });

            socket.on('transnotify', function(data){

                console.log('Notification Message: ', data);
                alert("Received new coins: " + data.Amount);

            });
            
            //-- Get BTC and  Balance
            socket.on('getbtc', function (data) {
                  
                  _headerView.render(data);

                  //-- console.log('BTC DATA HAS BEEN LOADED !!! ', data);
                  if(data.ErrorCode === 0)
                  {
                      new QRCode(document.getElementById("qrcode"), data.BTCAdress);
                  }
                 
                  $("#btcadress").val(data.BTCAdress);
                  $("#directpaymentbutton").attr("href", "bitcoin:"+data.BTCAdress+"?message=playza");
                  $("#userbalance").text(data.BTCbalance);

            });

            //--Betresponce 
            socket.on('betresponse', function(data){
                
                console.log('Bet response is: ', data);
                
                if(data.ErrorCode !== 0) 
                {                     
                    var errormessage = 
                    [ 
                            { "Code": 203,  "msg": "Not Enough BTC" }, 
                            { "Code": 1000, "msg": "Bet already taken" },
                            { "Code": 200,  "msg": "Session Not Found"},
                            { "Code": 202,  "msg": "No Wallet Found"},
                            { "Code": 204,  "msg": "General System Error 204 !!!" },
                            { "Code": 207,  "msg": "General System Error 207 !!!"  },
                            { "Code": 209,  "msg": "General System Error 209 !!!"  }
                    ];

                   var errrorrrr  =  _.findWhere(errormessage, {Code: data.ErrorCode} );
                   alert('Error: ' + errrorrrr.msg);
                   return; 

                };

                var tdCls = "success";
                if(data.winAmount === 0)
                {
                    tdCls = "danger";
                }
                var resp = "<tr class='"+tdCls+"'><td>" + data.betAmount + "</td><td>" +(data.winAmount).toFixed(8) + "</td><td>" +  data.curentbalance + "</td></tr>";

                $("#bethistory .table").prepend(resp);
                $("#userbalance").text(data.curentbalance);


            });

            socket.on('betallmessage', function(data){
                  
                  console.log(data);
                  var j = data;
                  console.log('betidtemid:', data.buttremained);


                  $("#buttonsremained").text(data.buttremained);

                  //var abc = $("button[data-index='+ data.id  +']")
                  var btn = $("button[data-index="+ data.betidtemid +"]");
                 
                  
                  var coef = data.betcoef;
                  var coeftoshow = coef;
                  var classname = 'btn btn-xs btn-hit';
                  
                  if(coef === 0)
                  {
                      classname = 'btn btn-xs btn-hit';
                      coeftoshow = '';

                  }else if(coef === 2)
                  {
                      classname = 'btn btn-xs btn-hit btn-warning';
                  }else if(coef === 3)
                  {
                      classname = 'btn btn-xs btn-hit  btn-success';
                  }else if(coef === 5)
                  {
                        classname = 'btn btn-xs btn-hit  btn-danger';

                  }else {

                      classname = 'btn btn-xs btn-hit  btn-primary';                        
                  }

                  btn.html(coeftoshow);
                  btn.attr('class', '');
                  btn.addClass(classname);


            });

        });

    </script>
    


</html>